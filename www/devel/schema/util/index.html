<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Openads Schema Utilities</title>
</head>
<body>
<?php
    $schemas = getSchemas();
    $changesets = getChangesets();
?>
<table style="">
<tr>
<td><a href="error_db.php">database errors</a></td>
<td><a href="error_fs.php">filesystem errors</a></td>
<td><a href="error_pa.php">parsing errors</a></td>
<td><a href="error_vl.php">validation errors</a></td>
<td><a href="error_pr.php">programmatic errors</a></td>
</tr>
</table>

<form action="index.php" method="POST">
<table>
<tr><td>
    <table>
    <tr><td>db type</td><td><input type="text" name="dsn[phptype]" value="<?php echo $dsn['phptype']; ?>"></td></tr>
    <tr><td>host</td><td><input type="text" name="dsn[hostspec]" value="<?php echo $dsn['hostspec']; ?>"></td></tr>
    <tr><td>username</td><td><input type="text" name="dsn[username]" value="<?php echo $dsn['username']; ?>"></td></tr>
    <tr><td>password</td><td><input type="text" name="dsn[password]" value="<?php echo $dsn['password']; ?>"></td></tr>
    <tr><td>db name</td><td><input type="text" name="dsn[database]" value="<?php echo $dsn['database']; ?>"></td></tr>
    <tr><td><button name="dump">Dump Schema as XML</button></td><td>to file&nbsp;<input type="text" name="dumpfile_mdbs" value="<?php echo $dumpfile_mdbs; ?>"></td></tr>
    <tr><td><button name="diff">Compare Database to XML Schema</button></td><td>in file&nbsp;<select name="filediff"><?php echo $schemas; ?></select></td></tr>
    <tr><td><button name="create">Create Database From Schema</button></td><td>in file&nbsp;<select name="filecreate"><?php echo $schemas; ?></select></td></tr>
    <tr><td><button name="show">View XSL formatted XML Schema</button></td><td>in file&nbsp;<select name="fileview"><?php echo $schemas; ?></select></td></tr>
    <tr><td><button name="diffx">Compare XML Schema</button></td><td>in file&nbsp;<select name="filediffx1"><?php echo $schemas; ?></select></td><td>to XML Schema&nbsp;<select name="filediffx2"><?php echo $schemas; ?></select></td><td>and dump to file&nbsp;<input type="text" name="dumpfile_mdbc" value="<?php echo $dumpfile_mdbc; ?>"><input type="checkbox" name="split"/>split?</td></tr>
    <tr><td><button name="parsec">Parse XML Changeset</button></td><td>in file&nbsp;<select name="fileview"><?php echo $changesets; ?></select></td></tr>
    </table>
</td></tr>
<table>
</form>
<div>
<?php
        if (is_array($changes) and (count($changes)>0))
        {
            if ($changes['tables']['add'])
            {
                echo '<h2>Add Tables</h2>';
                foreach ($changes['tables']['add'] AS $table=>$bool)
                {
                    echo $table.'<br />';
                    echo 'the structure of the table is defined in the new schema not the changeset<br />';
                }
            }
            if ($changes['remove'])
            {
                echo '<h2>Remove Tables</h2>';
                foreach ($changes['remove'] AS $table=>$bool)
                {
                    echo $table.'<br />';
                }
            }
            if ($changes['tables']['change'])
            {
                echo '<h2>Change Tables</h2>';
                foreach ($changes['tables']['change'] AS $table=>$aTable)
                {
                    echo '<br />TABLE: '.$table.'<br />';
                    if ($aTable['add'])
                    {
                        $aFields = $aTable['add'];
                        foreach ($aFields AS $field=>$aField)
                        {
                            echo 'ADD FIELD: '.$field.' => '.print_r($aField,true).'<br />';
                        }
                    }
                    if ($aTable['remove'])
                    {
                        $aFields = $aTable['remove'];
                        foreach ($aFields AS $field=>$bool)
                        {
                            echo 'REMOVE FIELD: '.$field.'<br />';
                        }
                    }
                    if ($aTable['change'])
                    {
                        foreach ($aTable['change'] AS $field=>$aField)
                        {
                            echo 'FIELD: '.$field.' => '.print_r($aField,true).'<br />';
                            foreach ($aField AS $k=>$v)
                            {
                                if (!is_array($v))
                                {
                                    switch ($k)
                                    {
                                        case 'was':
                                            echo "<b>FIELD {$field} {$k} {$aField['definition'][$k]}</b><br />";
                                            break;
                                        case 'notnull':
                                            echo "<b>CHANGE FIELD {$field} DECLARATION:  property {$k} to value ".($aField['definition'][$k] ? 'true' : 'false')."</b><br />";
                                            break;
                                        default:
                                            echo "<b>CHANGE FIELD {$field} DECLARATION:  property {$k} to value {$aField['definition'][$k]}</b><br />";
                                            break;
                                    }
                                }
                                else
                                {
                                    echo 'FIELD: '.$field.' '.$k.' => '.print_r($v,true).'.<br />';
                                }
                            }
                        }
                    }
                    if ($aTable['indexes']['change'])
                    {
                        foreach ($aTable['indexes']['change'] AS $index=>$aIndex)
                        {
                            echo 'INDEX: '.$index.' => '.print_r($aIndex,true).'<br />';
                            foreach ($aIndex['fields'] AS $ifield=>$aIfield)
                            {
                                echo 'INDEX FIELD: '.$ifield.' => '.print_r($aIfield,true).'<br />';
                                if (array_key_exists('sorting',$aIfield))
                                {
                                    echo "<b>CHANGE INDEX FIELD DECLARATION:  {$ifield} sorting to {$aIfield['sorting']}</b><br />";
                                }
                            }
                        }
                    }
                }
            }
        }
?>
</div>
<div>
<?php   if ($xmlchanges)
        {
            echo '<textarea cols="120" rows="40">';
            echo $xmlchanges;
            echo '</textarea>';
            echo '<br /><br />';
        }
?>
</div>
<div>
<?php
        if ($changes)
        {
            echo 'PARSED CHANGES<br />';
            echo '<textarea cols="120" rows="40">';
            //var_dump($changes);
            print_r($changes);
            echo '</textarea>';
            echo '<br /><br />';
        }
?>
</div>

<div>
<?php   if (is_array($warnings) and (count($warnings)>0))
        {
            echo '<h2>Warnings</h2>';
            foreach ($warnings AS $k=>$v)
            {
                echo $k.' => '.print_r($v,true).'<br /><br /><br />';
            }
        }
?>
</div>
</body>
</html>