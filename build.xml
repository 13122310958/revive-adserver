<project name="openads" default="release" basedir=".">
  <property name="test.conf.xml" value="devel.xml"/>
  <property name="dir.test.results" location="build/test-results"/>
  <property name="dir.test.reports" location="build/test-results"/>

  <patternset id="dist.included">
    <!-- Files in the main directory -->
    <include name="CHANGELOG.txt"/>
    <include name="INSTALL.txt"/>
    <include name="LICENSE.txt"/>
    <include name="README.txt"/>
    <include name="UPGRADE.txt"/>
    <include name="*.php"/>
    <include name="robots.txt"/>

    <!-- Subdirectory rules -->
    <include name="docs/**"/>
    <exclude name="docs/CODING_STANDARDS.txt"/>
    <exclude name="docs/developer"/>
    <exclude name="docs/developer/**"/>
    <include name="etc/**"/>
    <exclude name="etc/*.properties*"/>
    <exclude name="etc/test.conf.ini"/>
    <include name="lib/**"/>
    <exclude name="lib/simpletest/**"/>
    <include name="plugins/**"/>
    <include name="scripts/maintenance/**"/>
    <include name="scripts/.htaccess"/>
    <include name="var/cache/README.txt"/>
    <include name="var/plugins/**"/>
    <include name="var/.htaccess"/>
    <include name="www/**"/>
    <exclude name="www/devel**"/>

    <!-- Build-wide rules -->
    <exclude name="**/tests"/>
    <exclude name="**/tests/**"/>
  </patternset>

  <patternset id="dist.excluded">
    <!-- Files in the main directory -->
    <include name="tests.xsl"/>
    <include name="*.xml"/>
    <include name="should_not_exist"/><!-- Required for one of the tests - ask Andrew -->

    <!-- Subdirectory rules -->
    <include name="build/**"/>
    <include name="docs/CODING_STANDARDS.txt"/>
    <include name="docs/developer/**"/>
    <include name="etc/*.properties*"/>
    <include name="etc/test.conf.ini"/>
    <include name="lib/simpletest/**"/>
    <include name="scripts/db_dataobject/**"/>
    <include name="scripts/updateDocs.sh"/>
    <include name="tutorials/**"/>
    <include name="simulation/**"/>
    <include name="var/*.conf.ini*"/>
    <include name="var/changes_test*.xml"/>
    <include name="var/INSTALLED"/>
    <include name="var/cache/cache_*"/><!-- Cache files -->
    <include name="www/devel/**"/>

    <!-- Build-wide rules -->
    <include name="**/tests"/>
    <include name="**/tests/**"/>
    <include name="**/*.log"/><!-- Log files -->
    <include name="**/.*.swp"/><!-- Vim swap files -->
  </patternset>

  <!-- Openads Package Integrity Plugin -->
  <taskdef name="checkdistribution" classname="org.openads.ant.CheckDistributionTask"/>

  <target name="clean" description="Cleans all the files generated during the build.">
    <delete file="var/test.log" />
    <delete dir="build" />
    <delete file="tests.xml" />
  </target>

  <target name="checkconsistency"
    description="Checks whether all the files in the working directory are specified in the included or excluded lists of files.">
    <checkdistribution>
      <includeset dir="${basedir}">
        <patternset refid="dist.included"/>
      </includeset>
      <excludeset dir="${basedir}">
        <patternset refid="dist.excluded"/>
      </excludeset>
    </checkdistribution>
  </target>

  <target name="init">
    <touch file="should_not_exist"/>
    <mkdir dir="build/test-results"/>
    <mkdir dir="build/test-reports"/>
  </target>

  <target name="init-timestamp" unless="cctimestamp">
    <tstamp/>
    <property name="cctimestamp" value="${DSTAMP}${TSTAMP}"/>
  </target>

  <target name="init-label" unless="label">
    <property name="label" value="trunk"/>
  </target>

  <target name="init-release" unless="release" depends="checkconsistency, init, init-timestamp,init-label">
    <property name="release" value="openads-${label}-${cctimestamp}"/>
  </target>

  <target name="test-prepare">
    <xslt style="tests.xsl" in="${test.conf.xml}" out="tests.xml"/>
  </target>

  <target name="test-all" depends="init,test-prepare">
    <ant antfile="tests.xml"/>
  </target>

  <target name="release" depends="init-release" description="Creates a release packages in tar.bz2, tar.gz and zip formats.">
    <tar destfile="${dir.test.results}/${release}.tar.bz2" basedir="." compression="bzip2" longfile="gnu">
      <patternset refid="dist.included"/>
    </tar>
    <tar destfile="${dir.test.results}/${release}.tar.gz" basedir="." compression="gzip" longfile="gnu">
      <patternset refid="dist.included"/>
    </tar>
    <zip destfile="${dir.test.results}/${release}.zip" basedir=".">
      <patternset refid="dist.included"/>
    </zip>
  </target>

  <target name="simpletest" depends="clean, checkconsistency, init, test-all, release" />

</project>
