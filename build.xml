<project name="openads" default="simpletest" basedir=".">
  <target name="simpletest" depends="clean, checkconsistency, init, test-all, phpunit, release" />
  <property name="max.php_cli_executable" value="/usr/local/php4/bin/php" />
  <property name="test.conf.xml" value="devel.xml"/>
  <property name="dir.test.results" location="build/test-results"/>
  <property name="dir.test.reports" location="build/test-results"/>

  <patternset id="dist.included">
    <exclude name="**/tests"/>
    <exclude name="**/tests/**"/>
    <exclude name="*.xml"/>
    <exclude name="simulation"/>
    <exclude name="simulation/**"/>
    <exclude name="build"/>
    <exclude name="build/**"/>
    <exclude name="www/devel**"/>
  </patternset>

  <patternset id="dist.excluded">
    <include name="**/tests"/>
    <include name="**/tests/**"/>
    <include name="*.xml"/>
    <include name="simulation"/>
    <include name="simulation/**"/>
    <include name="build"/>
    <include name="build/**"/>
    <include name="www/devel**"/>
    <include name="www/devel/**"/>
  </patternset>

  <!-- Openads Package Integrity Plugin -->
  <taskdef name="checkdistribution" classname="org.openads.ant.CheckDistributionTask"/>

  <target name="clean">
    <delete file="var/test.log" />
    <delete dir="build" />
  </target>

  <target name="checkconsistency">
    <checkdistribution>
      <includeset dir="${basedir}">
        <patternset refid="dist.included"/>
      </includeset>
      <excludeset dir="${basedir}">
        <patternset refid="dist.excluded"/>
      </excludeset>
    </checkdistribution>
  </target>

  <target name="init">
    <touch file="should_not_exist"/>
    <mkdir dir="build/test-results"/>
    <mkdir dir="build/test-reports"/>
  </target>

  <target name="init-timestamp" unless="cctimestamp">
    <tstamp/>
    <property name="cctimestamp" value="${DSTAMP}${TSTAMP}"/>
  </target>

  <target name="init-label" unless="label">
    <property name="label" value="trunk"/>
  </target>

  <target name="init-release" unless="release" depends="init-timestamp,init-label">
    <property name="release" value="openads-${label}-${cctimestamp}"/>
  </target>

  <target name="test-prepare">
    <xslt style="tests.xsl" in="${test.conf.xml}" out="tests.xml"/>
  </target>

  <target name="test-all" depends="init,test-prepare">
    <ant antfile="tests.xml"/>
  </target>

  <target name="phpunit">
    <exec dir="tests" executable="${max.php_cli_executable}" failonerror="true" output="build/test-results/MDB2.html">
      <arg value="run.php" />
      <arg value="--type=phpunit" />
      <arg value="--dir=../lib/pear/MDB2/tests/" />
    </exec>
    <exec dir="tests" executable="${max.php_cli_executable}" failonerror="false" output="build/test-results/MDB2_Schema.html">
      <arg value="run.php" />
      <arg value="--type=phpunit" />
      <arg value="--dir=../lib/pear/MDB2_Schema/tests/" />
    </exec>
  </target>

  <target name="release" depends="init-release">
    <tar destfile="${dir.test.results}/${release}.tar.bz2" basedir="." compression="bzip2" longfile="gnu">
      <patternset refid="dist.included"/>
    </tar>
  </target>

</project>
